#!/bin/sh
set -e

cd /work
git clone https://github.com/neovim/neovim.git -b v0.10.3
cd neovim
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$PWD/PREFIX
make -j$(nproc)
make install
# Truly cursed, but easier than wrangling CMake to produce a static binary.
cd src/nvim
/usr/bin/cc -static -O3 -DNDEBUG -flto=auto -fno-fat-lto-objects -Wl,--export-dynamic -rdynamic -Wl,--dependency-file=CMakeFiles/nvim_bin.dir/link.d CMakeFiles/nvim_bin.dir/__/__/test/unit/fixtures/multiqueue.c.o CMakeFiles/nvim_bin.dir/__/__/test/unit/fixtures/rbuffer.c.o CMakeFiles/nvim_bin.dir/api/autocmd.c.o CMakeFiles/nvim_bin.dir/api/buffer.c.o CMakeFiles/nvim_bin.dir/api/command.c.o CMakeFiles/nvim_bin.dir/api/deprecated.c.o CMakeFiles/nvim_bin.dir/api/extmark.c.o CMakeFiles/nvim_bin.dir/api/options.c.o CMakeFiles/nvim_bin.dir/api/private/converter.c.o CMakeFiles/nvim_bin.dir/api/private/dispatch.c.o CMakeFiles/nvim_bin.dir/api/private/helpers.c.o CMakeFiles/nvim_bin.dir/api/private/validate.c.o CMakeFiles/nvim_bin.dir/api/tabpage.c.o CMakeFiles/nvim_bin.dir/api/ui.c.o CMakeFiles/nvim_bin.dir/api/vim.c.o CMakeFiles/nvim_bin.dir/api/vimscript.c.o CMakeFiles/nvim_bin.dir/api/win_config.c.o CMakeFiles/nvim_bin.dir/api/window.c.o CMakeFiles/nvim_bin.dir/arabic.c.o CMakeFiles/nvim_bin.dir/arglist.c.o CMakeFiles/nvim_bin.dir/autocmd.c.o CMakeFiles/nvim_bin.dir/base64.c.o CMakeFiles/nvim_bin.dir/buffer.c.o CMakeFiles/nvim_bin.dir/buffer_updates.c.o CMakeFiles/nvim_bin.dir/bufwrite.c.o CMakeFiles/nvim_bin.dir/change.c.o CMakeFiles/nvim_bin.dir/channel.c.o CMakeFiles/nvim_bin.dir/charset.c.o CMakeFiles/nvim_bin.dir/cmdexpand.c.o CMakeFiles/nvim_bin.dir/cmdhist.c.o CMakeFiles/nvim_bin.dir/context.c.o CMakeFiles/nvim_bin.dir/cursor.c.o CMakeFiles/nvim_bin.dir/cursor_shape.c.o CMakeFiles/nvim_bin.dir/debugger.c.o CMakeFiles/nvim_bin.dir/decoration.c.o CMakeFiles/nvim_bin.dir/decoration_provider.c.o CMakeFiles/nvim_bin.dir/diff.c.o CMakeFiles/nvim_bin.dir/digraph.c.o CMakeFiles/nvim_bin.dir/drawline.c.o CMakeFiles/nvim_bin.dir/drawscreen.c.o CMakeFiles/nvim_bin.dir/edit.c.o CMakeFiles/nvim_bin.dir/eval.c.o CMakeFiles/nvim_bin.dir/eval/buffer.c.o CMakeFiles/nvim_bin.dir/eval/decode.c.o CMakeFiles/nvim_bin.dir/eval/encode.c.o CMakeFiles/nvim_bin.dir/eval/executor.c.o CMakeFiles/nvim_bin.dir/eval/funcs.c.o CMakeFiles/nvim_bin.dir/eval/gc.c.o CMakeFiles/nvim_bin.dir/eval/typval.c.o CMakeFiles/nvim_bin.dir/eval/userfunc.c.o CMakeFiles/nvim_bin.dir/eval/vars.c.o CMakeFiles/nvim_bin.dir/eval/window.c.o CMakeFiles/nvim_bin.dir/event/libuv_process.c.o CMakeFiles/nvim_bin.dir/event/loop.c.o CMakeFiles/nvim_bin.dir/event/multiqueue.c.o CMakeFiles/nvim_bin.dir/event/process.c.o CMakeFiles/nvim_bin.dir/event/rstream.c.o CMakeFiles/nvim_bin.dir/event/signal.c.o CMakeFiles/nvim_bin.dir/event/socket.c.o CMakeFiles/nvim_bin.dir/event/stream.c.o CMakeFiles/nvim_bin.dir/event/time.c.o CMakeFiles/nvim_bin.dir/event/wstream.c.o CMakeFiles/nvim_bin.dir/ex_cmds.c.o CMakeFiles/nvim_bin.dir/ex_cmds2.c.o CMakeFiles/nvim_bin.dir/ex_docmd.c.o CMakeFiles/nvim_bin.dir/ex_eval.c.o CMakeFiles/nvim_bin.dir/ex_getln.c.o CMakeFiles/nvim_bin.dir/ex_session.c.o CMakeFiles/nvim_bin.dir/extmark.c.o CMakeFiles/nvim_bin.dir/file_search.c.o CMakeFiles/nvim_bin.dir/fileio.c.o CMakeFiles/nvim_bin.dir/fold.c.o CMakeFiles/nvim_bin.dir/garray.c.o CMakeFiles/nvim_bin.dir/getchar.c.o CMakeFiles/nvim_bin.dir/grid.c.o CMakeFiles/nvim_bin.dir/hashtab.c.o CMakeFiles/nvim_bin.dir/help.c.o CMakeFiles/nvim_bin.dir/highlight.c.o CMakeFiles/nvim_bin.dir/highlight_group.c.o CMakeFiles/nvim_bin.dir/indent.c.o CMakeFiles/nvim_bin.dir/indent_c.c.o CMakeFiles/nvim_bin.dir/input.c.o CMakeFiles/nvim_bin.dir/insexpand.c.o CMakeFiles/nvim_bin.dir/keycodes.c.o CMakeFiles/nvim_bin.dir/linematch.c.o CMakeFiles/nvim_bin.dir/log.c.o CMakeFiles/nvim_bin.dir/lua/api_wrappers.c.o CMakeFiles/nvim_bin.dir/lua/base64.c.o CMakeFiles/nvim_bin.dir/lua/converter.c.o CMakeFiles/nvim_bin.dir/lua/executor.c.o CMakeFiles/nvim_bin.dir/lua/secure.c.o CMakeFiles/nvim_bin.dir/lua/spell.c.o CMakeFiles/nvim_bin.dir/lua/stdlib.c.o CMakeFiles/nvim_bin.dir/lua/treesitter.c.o CMakeFiles/nvim_bin.dir/lua/xdiff.c.o CMakeFiles/nvim_bin.dir/main.c.o CMakeFiles/nvim_bin.dir/map.c.o CMakeFiles/nvim_bin.dir/map_glyph_cache.c.o CMakeFiles/nvim_bin.dir/mapping.c.o CMakeFiles/nvim_bin.dir/mark.c.o CMakeFiles/nvim_bin.dir/marktree.c.o CMakeFiles/nvim_bin.dir/match.c.o CMakeFiles/nvim_bin.dir/math.c.o CMakeFiles/nvim_bin.dir/mbyte.c.o CMakeFiles/nvim_bin.dir/memfile.c.o CMakeFiles/nvim_bin.dir/memline.c.o CMakeFiles/nvim_bin.dir/memory.c.o CMakeFiles/nvim_bin.dir/menu.c.o CMakeFiles/nvim_bin.dir/message.c.o CMakeFiles/nvim_bin.dir/mouse.c.o CMakeFiles/nvim_bin.dir/move.c.o CMakeFiles/nvim_bin.dir/msgpack_rpc/channel.c.o CMakeFiles/nvim_bin.dir/msgpack_rpc/packer.c.o CMakeFiles/nvim_bin.dir/msgpack_rpc/server.c.o CMakeFiles/nvim_bin.dir/msgpack_rpc/unpacker.c.o CMakeFiles/nvim_bin.dir/normal.c.o CMakeFiles/nvim_bin.dir/ops.c.o CMakeFiles/nvim_bin.dir/option.c.o CMakeFiles/nvim_bin.dir/optionstr.c.o CMakeFiles/nvim_bin.dir/os/dl.c.o CMakeFiles/nvim_bin.dir/os/env.c.o CMakeFiles/nvim_bin.dir/os/fileio.c.o CMakeFiles/nvim_bin.dir/os/fs.c.o CMakeFiles/nvim_bin.dir/os/input.c.o CMakeFiles/nvim_bin.dir/os/lang.c.o CMakeFiles/nvim_bin.dir/os/mem.c.o CMakeFiles/nvim_bin.dir/os/process.c.o CMakeFiles/nvim_bin.dir/os/pty_process_unix.c.o CMakeFiles/nvim_bin.dir/os/shell.c.o CMakeFiles/nvim_bin.dir/os/signal.c.o CMakeFiles/nvim_bin.dir/os/stdpaths.c.o CMakeFiles/nvim_bin.dir/os/time.c.o CMakeFiles/nvim_bin.dir/os/users.c.o CMakeFiles/nvim_bin.dir/path.c.o CMakeFiles/nvim_bin.dir/plines.c.o CMakeFiles/nvim_bin.dir/popupmenu.c.o CMakeFiles/nvim_bin.dir/profile.c.o CMakeFiles/nvim_bin.dir/quickfix.c.o CMakeFiles/nvim_bin.dir/rbuffer.c.o CMakeFiles/nvim_bin.dir/regexp.c.o CMakeFiles/nvim_bin.dir/runtime.c.o CMakeFiles/nvim_bin.dir/search.c.o CMakeFiles/nvim_bin.dir/sha256.c.o CMakeFiles/nvim_bin.dir/shada.c.o CMakeFiles/nvim_bin.dir/sign.c.o CMakeFiles/nvim_bin.dir/spell.c.o CMakeFiles/nvim_bin.dir/spellfile.c.o CMakeFiles/nvim_bin.dir/spellsuggest.c.o CMakeFiles/nvim_bin.dir/state.c.o CMakeFiles/nvim_bin.dir/statusline.c.o CMakeFiles/nvim_bin.dir/strings.c.o CMakeFiles/nvim_bin.dir/syntax.c.o CMakeFiles/nvim_bin.dir/tag.c.o CMakeFiles/nvim_bin.dir/terminal.c.o CMakeFiles/nvim_bin.dir/testing.c.o CMakeFiles/nvim_bin.dir/textformat.c.o CMakeFiles/nvim_bin.dir/textobject.c.o CMakeFiles/nvim_bin.dir/tui/input.c.o CMakeFiles/nvim_bin.dir/tui/terminfo.c.o CMakeFiles/nvim_bin.dir/tui/tui.c.o CMakeFiles/nvim_bin.dir/ugrid.c.o CMakeFiles/nvim_bin.dir/ui.c.o CMakeFiles/nvim_bin.dir/ui_client.c.o CMakeFiles/nvim_bin.dir/ui_compositor.c.o CMakeFiles/nvim_bin.dir/undo.c.o CMakeFiles/nvim_bin.dir/usercmd.c.o CMakeFiles/nvim_bin.dir/version.c.o CMakeFiles/nvim_bin.dir/viml/parser/expressions.c.o CMakeFiles/nvim_bin.dir/viml/parser/parser.c.o CMakeFiles/nvim_bin.dir/window.c.o CMakeFiles/nvim_bin.dir/winfloat.c.o CMakeFiles/nvim_bin.dir/__/cjson/fpconv.c.o CMakeFiles/nvim_bin.dir/__/cjson/lua_cjson.c.o CMakeFiles/nvim_bin.dir/__/cjson/strbuf.c.o CMakeFiles/nvim_bin.dir/__/mpack/conv.c.o CMakeFiles/nvim_bin.dir/__/mpack/lmpack.c.o CMakeFiles/nvim_bin.dir/__/mpack/mpack_core.c.o CMakeFiles/nvim_bin.dir/__/mpack/object.c.o CMakeFiles/nvim_bin.dir/__/mpack/rpc.c.o "CMakeFiles/nvim_bin.dir/__/termkey/driver-csi.c.o" "CMakeFiles/nvim_bin.dir/__/termkey/driver-ti.c.o" CMakeFiles/nvim_bin.dir/__/termkey/termkey.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xdiffi.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xemit.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xhistogram.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xpatience.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xprepare.c.o CMakeFiles/nvim_bin.dir/__/xdiff/xutils.c.o -o ../../bin/nvim  -lluv -lvterm /usr/lib/lua/5.1/lpeg.a -lmsgpack-c -ltree-sitter -lunibilium -lintl -lluajit-5.1 -fstack-protector-strong -lm -lutil -luv -ldl -lrt
cd ../..
cp bin/nvim PREFIX/bin/nvim
strip --strip-unneeded PREFIX/bin/nvim
